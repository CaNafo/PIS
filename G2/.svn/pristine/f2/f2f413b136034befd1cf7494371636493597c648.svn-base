package model;

import java.io.File;
import java.io.IOException;

import javax.xml.parsers.ParserConfigurationException;
import javax.xml.parsers.SAXParser;
import javax.xml.parsers.SAXParserFactory;

import org.xml.sax.Attributes;
import org.xml.sax.SAXException;
import org.xml.sax.helpers.DefaultHandler;

public class TableXmlParser extends DefaultHandler {
	private TableDataModel table = null;
	private String columnType = "";
	private int currentFK = 0;

	private String lastTableName = "";

	@Override
	public void startElement(String uri, String localName, String qName, Attributes attributes) throws SAXException {
		switch (qName) {
		case "table":
			table = new TableDataModel(attributes.getValue("name"));
			break;
		case "column":
			if (columnType == "") {
				String name = attributes.getValue("name");
				String data_type = attributes.getValue("data_type");
				Boolean isNullable = (attributes.getValue("null") == "YES") ? true : false;
				Boolean isAutoincrement = (attributes.getValue("autoincrement") == "YES") ? true : false;
				Boolean isName = (attributes.getValue("isName").equals("true")) ? true : false;
				table.getColumns().add(new TableColumn(name, data_type, isNullable, isAutoincrement, isName));
			} else if (columnType == "fk") {
				table.getColumnByName(attributes.getValue("child_name"))
						.setParrentName(attributes.getValue("parent_name"));
				table.getForeignKeys().get(currentFK).getColumns()
						.add(table.getColumnByName(attributes.getValue("child_name")));
			} else if (columnType == "pk") {
				table.getPrimaryKey().getColumns().add(table.getColumnByName(attributes.getValue("name")));
			}
			break;
		case "pk":
			columnType = "pk";
			table.setPrimaryKey(new TableKey(attributes.getValue("name")));
			break;
		case "fk":
			columnType = "fk";
			table.getForeignKeys().add(new TableKey(attributes.getValue("name")));
			table.getForeignKeyByName(attributes.getValue("name")).setParentTable(attributes.getValue("parent_table"));
			break;
		case "reference":
			columnType = "reference";

			break;
		}
	}

	@Override
	public void endElement(String uri, String localName, String qName) throws SAXException {
		if (columnType != "" && qName != "column")
			columnType = "";
		if (qName == "fk")
			currentFK++;
	}

	@Override
	public void endDocument() throws SAXException {
//		table.fetchData();
	}

	private void parse(String tableName) {
		SAXParserFactory parserFactory = SAXParserFactory.newInstance();
		parserFactory.setValidating(false);
		parserFactory.setNamespaceAware(false);
		try {
			SAXParser parser = parserFactory.newSAXParser();
			parser.parse("resources" + File.separator + tableName + ".xml", this);
		} catch (ParserConfigurationException | org.xml.sax.SAXException | IOException e) {
			e.printStackTrace();
		}
	}

	public TableDataModel getTable(String tableName) {
		if (table == null && lastTableName != tableName)
			parse(tableName);
		lastTableName = tableName;
		return table;
	}
}
