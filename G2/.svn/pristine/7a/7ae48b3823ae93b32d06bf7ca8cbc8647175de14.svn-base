package controller;

import java.awt.Dimension;
import java.awt.event.ActionEvent;
import java.awt.event.ActionListener;
import java.sql.Date;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.sql.Statement;
import java.util.HashMap;
import java.util.Vector;

import javax.swing.JDialog;
import javax.swing.JTable;
import javax.swing.table.DefaultTableModel;

import com.microsoft.sqlserver.jdbc.SQLServerResultSet;

import application.MainVindow;
import helpers.DatabaseConnection;
import model.KorisnikModel;
import net.sf.jasperreports.engine.JRException;
import net.sf.jasperreports.engine.JasperFillManager;
import net.sf.jasperreports.engine.JasperPrint;
import net.sf.jasperreports.engine.data.JRTableModelDataSource;
import net.sf.jasperreports.view.JasperViewer;
import view.LogsView;
import view.MenuBarView;

public class MenuBarController {
	
	private MenuBarView barView;
	private DatabaseConnection conn;	
	private Statement stmt;
	private KorisnikModel korisnik;
	private DefaultTableModel tableModel;
	private JTable table = new JTable();
	
	
	
	public MenuBarController(MenuBarView barView) {
		conn = DatabaseConnection.getInstance();
		try {
			stmt = conn.getDbConnection().createStatement();
		} catch (SQLException e) {
			// TODO Auto-generated catch block
			e.printStackTrace();
		}
		korisnik = KorisnikModel.getInstance();

		this.barView = barView;
		barView.addActionListeners(menuBarActionListener);
	}
	
	ActionListener menuBarActionListener = new ActionListener() {
		
		@Override
		public void actionPerformed(ActionEvent arg0) {
			switch (arg0.getActionCommand()) {
			case "showLogs":
				showLogWinow();
				break;
			case "exitApplication":
				MainVindow mainVindow = (MainVindow)barView.getParent().getParent().getParent();
				mainVindow.dispose();
				break;
			case "clanoviReport":
				populateClanovi(korisnik.getID_PoslovnogSitema());
				displayReport("reports/Clanovi.jasper");
				table.setModel(tableModel);
				break;
			case "finansijskaKarticaReport":
				populateFinancijskaKartica(korisnik.getID_PoslovnogSitema());
				displayReport("reports/FinansijskaKartica.jasper");
				table.setModel(tableModel);
				break;
			case "stanjeGradjeReport":
				populateGradja(korisnik.getID_PoslovnogSitema());
				displayReport("reports/Gradja.jasper");
				table.setModel(tableModel);
				break;
			case "istorijaIzdavanjaReport":
				populateIstorijaIzdavanja(korisnik.getID_PoslovnogSitema());
				displayReport("reports/IstorijaIzdavanjaClana.jasper");
				table.setModel(tableModel);
				break;
			default:
				break;
			}
			
		}
	};
	
	private void showLogWinow() {
		int i = 0;
		JDialog logs = new JDialog();
		Vector<Vector<String>> data = null;
		int ID;
		String korisnickoIme, vrijeme, datum, IP = "";
		String[] columnNames = {"ID korisnika", "Korisnièko ime", "Vrijeme", "Datum", "IP-adresa" };
		try {
			ResultSet rs = stmt.executeQuery("SELECT * FROM LogoviPoslovnogSistema ORDER BY Datum, Vrijeme ASC");
			data = new Vector<>();
			while(rs.next()) {
				data.add(new Vector<>());
				ID = rs.getInt("KorisnikID");
				korisnickoIme = rs.getString("KorisnickoIme");
				vrijeme = rs.getTime("Vrijeme").toString();
				datum = rs.getDate("Datum").toString();
				IP = rs.getString("IPadresa");
				
				if(rs.getString("IPadresa") == null)
					IP = "unknown";
				
				data.get(i).add(ID+"");
				data.get(i).add(korisnickoIme);
				data.get(i).add(vrijeme);
				data.get(i).add(datum);
				data.get(i).add(IP);
				
				i++;
			}
		} catch (SQLException e) {
			// TODO Auto-generated catch block
			e.printStackTrace();
		}
		
		if(data!=null) {
			logs.setTitle("Log Window");
			logs.setDefaultCloseOperation(logs.DISPOSE_ON_CLOSE);
			logs.setSize(new Dimension(500, 600));
			logs.setMinimumSize(new Dimension(450, 600));
			logs.setLocationRelativeTo(null);
			logs.add(new LogsView(data,columnNames));
			logs.setVisible(true);
		}
	}
	
	
	private void displayReport(String reportPath) {
		JasperPrint jasperPrint = generateReport(reportPath);
		JasperViewer jasperViewer = new JasperViewer(jasperPrint,false);
		jasperViewer.setVisible(true);
	}
	
	
	

	private JasperPrint generateReport(String reportPath) {
		JasperPrint jasperPrint = null;

		try {
			HashMap param = new HashMap();
			param.put("ps_naziv", getPS_Naziv(korisnik.getID_PoslovnogSitema()));
			jasperPrint = JasperFillManager.fillReport(reportPath, param,
					new JRTableModelDataSource(tableModel));

		} catch (JRException e) {
			e.printStackTrace();
		}
		return jasperPrint;
	}

	
	
	
	private String getPS_Naziv(int id_ps) {
		String select = "SELECT PS_NAZIV FROM POSLOVNI_SISTEM WHERE PS_IDENTIFIKATOR="+id_ps;

		try {
			ResultSet rs = stmt.executeQuery(select);
			
		    if (rs.next()) {
		    	String naziv = rs.getString("PS_NAZIV");
		    	return naziv;
		    }
		} catch (SQLException e) {
			e.printStackTrace();
		}
		
		return null;
	}	
	
	
	private void populateFinancijskaKartica(int id_ps) {

		String[] columnNames = {"FK_Godina", "FK_Stanje"};
		
		String select = "SELECT * FROM [Finansijska kartica] where Poslovni_sistem_ID = "+id_ps;				
		tableModel = new DefaultTableModel(null, columnNames);
		try {
			ResultSet rs =  stmt.executeQuery(select);
		    while (rs.next()) {
		    	int g = rs.getDate("FK_Godina").getYear();
				String[] fin_kartica = {g+"", rs.getString("FK_Stanje")};
				tableModel.addRow(fin_kartica);
		    }
		} catch (SQLException e) {
			e.printStackTrace();
		}
	}
	
	private void populateIstorijaIzdavanja(int id_ps) {

		String[] columnNames = {"Cl_ImePrezime", "Cl_ClanskiBroj", "KG_Naziv", "II_Datum izdavanja", "II_Datum vracanja", "II_Placeno" };
		
		String select = "SELECT * FROM [Istorija izdavanja]\r\n" + 
				"JOIN KonkretnaGradja on [Istorija izdavanja].Konkretna_gradja_ID = KonkretnaGradja.KG_ID\r\n" + 
				"JOIN Clan on [Istorija izdavanja].Cl_ID = Clan.Cl_ID "+
				"Where [Istorija izdavanja].Poslovni_sistem_ID="+id_ps;
		
		
		tableModel = new DefaultTableModel(null, columnNames);

		try {
			ResultSet rs = stmt.executeQuery(select);
			
		    while (rs.next()) {
				String[] ist_izdavanja = {rs.getString("Cl_ImePrezime"), rs.getString("Cl_ClanskiBroj"), rs.getString("KG_Naziv"), rs.getString("II_Datum izdavanja"), rs.getString("II_Datum_vracanja"), rs.getString("II_Placeno").equals("1") ? "Da" : "Ne"};
				tableModel.addRow(ist_izdavanja);
		    }
		} catch (SQLException e) {
			e.printStackTrace();
		}
	}
	
	
	private void populateGradja(int id_ps) {

		String[] columnNames = { "GR_Naziv", "TG_Naziv", "ukupno", "Izdato", "Rezervisano" };
		
		String select = "SELECT  Gradja.GR_Naziv,TipGradje.TG_Naziv, KonkretnaGradja.Poslovni_sistem_ID, KonkretnaGradja.Organizaciona_jedinica_ID,   count(*) ukupno, sum(case when KG_Izdato = 1 then 1 else 0 end) Izdato,\r\n" + 
				"  sum(case when KG_Rezervisano = 1 then 1 else 0 end) Rezervisano\r\n" + 
				"from KonkretnaGradja join Gradja on KonkretnaGradja.GR_ID = Gradja.GR_ID join TipGradje on Gradja.TG_ID = TipGradje.TG_ID WHERE Gradja.Poslovni_sistem_ID = "+id_ps+"\r\n" + 
				"group by KonkretnaGradja.Poslovni_sistem_ID, KonkretnaGradja.Organizaciona_jedinica_ID, Gradja.GR_Naziv,TipGradje.TG_Naziv;";
		
		
		tableModel = new DefaultTableModel(null, columnNames);

		try {
			ResultSet rs = stmt.executeQuery(select);
			
		    while (rs.next()) {
				String[] gradja = {rs.getString("GR_Naziv"), rs.getString("TG_Naziv"), rs.getString("ukupno"), rs.getString("Izdato"), rs.getString("Rezervisano")};
				tableModel.addRow(gradja);
		    }
		} catch (SQLException e) {
			e.printStackTrace();
		}
	}
	
	private void populateClanovi(int id_ps) {
		
		
		String[] columnNames = { "Cl_ClanskiBroj", "Cl_ImePrezime", "Cl_DatumUclanjenja" };
		
		String select = "SELECT * FROM Clan WHERE Poslovni_sistem_ID="+id_ps;		
		tableModel = new DefaultTableModel(null, columnNames);

		try {
			ResultSet rs = stmt.executeQuery(select);
			
		    while (rs.next()) {
				String[] clanovi = {rs.getString("Cl_ClanskiBroj"), rs.getString("Cl_ImePrezime"), rs.getString("Cl_DatumUclanjenja")};
				tableModel.addRow(clanovi);
		    }
		} catch (SQLException e) {
			e.printStackTrace();
		}
				
	}
}
